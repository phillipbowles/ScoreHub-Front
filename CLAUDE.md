# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ScoreHub-Front** is a React Native mobile application built with Expo for tracking game scores. It connects to a Laravel backend API (Score-Hub-Back) for user authentication, game management, and match tracking.

## Tech Stack

- **React Native 0.81** with **Expo 54**
- **TypeScript 5.9** with strict mode
- **React Navigation 7** (Stack + Bottom Tabs)
- **NativeWind 2.0** (Tailwind CSS for React Native)
- **AsyncStorage** for local token persistence
- **Phosphor React Native** for icons
- **react-native-dotenv** for environment variables

## Development Commands

```bash
# Start development server
npm start
npx expo start

# Clear cache and restart
npx expo start --clear

# Platform-specific
npx expo start --ios       # iOS simulator
npx expo start --android   # Android emulator
npx expo start --web       # Web browser

# Auto-detect backend IP (must run before starting Expo)
./detect-ip.sh            # Creates src/config/api-config.ts
```

## Architecture

### Project Structure

```
src/
├── components/
│   ├── common/          # Shared components (ScreenHeader, InputField, etc.)
│   ├── ui/              # Base UI components (Button, Input, Card)
│   ├── game/            # Game-specific components (ScoreBoard, GameHeader, etc.)
│   └── match/           # Match-specific components
├── screens/
│   ├── auth/            # LoginScreen, RegisterScreen
│   ├── game/            # CreateGameScreen, GameScreen
│   ├── match/           # SelectGameTypeScreen, GameListScreen, MatchConfigScreen
│   ├── HomeScreen.tsx
│   ├── StatsScreen.tsx
│   └── ProfileScreen.tsx
├── navigation/
│   └── AppNavigator.tsx # Navigation configuration (Stack + Bottom Tabs)
├── types/
│   ├── index.ts         # Frontend types (User, Game, Player, Navigation)
│   ├── backend.types.ts # Backend API types (BackendGame, CreateGameRequest)
│   └── game.types.ts    # Game state types (Player, Team, GameConfig)
├── utils/
│   ├── api.ts           # API service singleton (apiService)
│   └── storage.ts       # AsyncStorage utilities
├── config/
│   └── api-config.ts    # Auto-generated by detect-ip.sh
└── styles/
    └── global.ts        # Global styles
```

### Key Patterns

**Navigation Architecture**: Two-level navigation with Stack Navigator wrapping Bottom Tab Navigator
- Auth screens (Login, Register) outside tabs
- Main app uses Bottom Tabs (Home, Games, Stats, Profile)
- Game flow screens (CreateGame, GameList, MatchConfig) accessible from tabs

**API Service Pattern**: Singleton service (`apiService`) with centralized request handling
- All API calls go through `src/utils/api.ts`
- JWT Bearer token automatically attached from AsyncStorage
- Response format: `{ success: boolean, data?: T, error?: string }`
- API URL auto-detected via `detect-ip.sh` script

**Type System**: Three-layer type architecture
- `types/index.ts`: Frontend domain types and navigation types
- `types/backend.types.ts`: Backend API contract types (matches Laravel responses)
- `types/game.types.ts`: Game state and runtime types

**Component Composition**: Reusable components with consistent patterns
- `ScreenHeader`: Standard header with title, subtitle, and optional icons
- `SettingItem`: Polymorphic setting component (toggle, counter, segmented, navigation)
- `InputField`: Labeled input with validation indicators
- `Card`: Base container component with consistent padding/styling

## API Integration

### Authentication Flow

1. Login/Register screens call `apiService.login()` or `apiService.register()`
2. Token stored in AsyncStorage: `await AsyncStorage.setItem('userToken', token)`
3. All subsequent requests automatically include `Authorization: Bearer {token}` header
4. Backend uses JWT authentication (php-open-source-saver/jwt-auth)

### Backend Endpoints

**Public Routes:**
- `POST /api/users` - Register
- `POST /api/users/login` - Login
- `GET /api/users` - List users
- `GET /api/users/{id}` - Get user

**Protected Routes (require auth token):**
- `GET /api/me` - Current user
- `GET /api/games` - List games
- `GET /api/games/{id}` - Get game
- `POST /api/games` - Create game
- `PUT /api/games/{id}` - Update game
- `POST /api/game-match` - Create match
- `GET /api/game-match/{id}` - Get match

### API Configuration

The app uses an auto-detection system for backend connectivity:

1. **Run `./detect-ip.sh`** before starting Expo
   - Detects all local IPs
   - Tests each IP for backend connectivity
   - Generates `src/config/api-config.ts` with working IP
   - Handles both port 80 and custom ports

2. **Fallback `.env` configuration** (legacy, still supported):
   ```env
   API_BASE_URL=http://localhost:8000/api
   API_TIMEOUT=10000
   ```

3. **apiService logs all requests:**
   ```
   🔧 API Configuration: { baseURL, timeout, platform }
   🌐 GET /games
   🔑 Token: eyJ0eXAiOiJKV1QiLCJ...
   ✅ GET /games - Success
   ```

## Common Development Tasks

### Adding a New Screen

1. Create screen component in `src/screens/{category}/`
2. Add route to `RootStackParamList` in `src/types/index.ts`
3. Register screen in `AppNavigator.tsx`:
   ```tsx
   <Stack.Screen name="NewScreen" component={NewScreenComponent} />
   ```
4. Navigate using: `navigation.navigate('NewScreen', { params })`

### Adding a New API Endpoint

1. Add method to `apiService` in `src/utils/api.ts`:
   ```typescript
   async getNewResource(): Promise<ApiResponse<ResourceType>> {
     return this.makeRequest<ResourceType>('/new-resource');
   }
   ```
2. Define types in `src/types/backend.types.ts` if backend-specific
3. Call from components: `await apiService.getNewResource()`

### Styling with NativeWind

Use Tailwind utility classes via `className` prop:
```tsx
<View className="flex-1 bg-gray-50 px-6">
  <Text className="text-lg font-bold text-black mb-4">Title</Text>
</View>
```

Custom colors and styles go in components as inline `style` prop when needed.

## Network Configuration

### Testing on Physical Devices

**Same WiFi Network:**
1. Run `./detect-ip.sh` to auto-configure
2. Backend must be accessible on network (not just localhost)
3. Start Expo and scan QR code

**Different Networks (ngrok):**
1. Install ngrok: `brew install ngrok`
2. Start backend: `cd Score-Hub-Back && php artisan serve`
3. Create tunnel: `ngrok http 8000`
4. Update `src/config/api-config.ts` with ngrok URL
5. Start Expo: `npx expo start --tunnel`

### Troubleshooting Network Issues

If API calls fail with "Network request failed":
1. Check backend is running: `curl http://localhost:8000/api/users`
2. Run `./detect-ip.sh` to verify connectivity
3. Check logs in Metro bundler for API configuration
4. Clear Expo cache: `npx expo start --clear`
5. Verify JWT auth guard in backend (see BACKEND_FIX.md)

## Backend Integration Notes

### JWT Authentication Setup

Backend uses `middleware(['auth'])` which defaults to `web` guard (sessions). For JWT to work:

**Option 1 (Recommended):** Add to backend `.env`:
```env
AUTH_GUARD=api
```

**Option 2:** Update backend routes to use `auth:api` middleware explicitly.

See `BACKEND_FIX.md` for complete details.

### Backend Type Mapping

Backend uses Laravel conventions, frontend uses camelCase:

**Backend:**
```typescript
{
  number_of_players: 4,
  has_teams: true,
  min_team_length: 2,
  max_team_length: 4
}
```

**Frontend:**
```typescript
{
  numberOfPlayers: 4,
  hasTeams: true,
  minTeamLength: 2,
  maxTeamLength: 4
}
```

Always use `backend.types.ts` for API requests/responses.

## Git Workflow

Current branch structure (from git status):
- `main`: Stable branch (target for PRs)
- `develop`: Active development branch (current)

## Common Issues

### "expo: command not found"
Use `npx expo start` instead of `expo start`

### Metro bundler cache issues
Clear with: `npx expo start --clear`

### Environment variables not loading
1. Ensure `.env` exists in project root
2. Restart Expo completely: Ctrl+C, then `npx expo start --clear`
3. Verify babel.config.js includes `react-native-dotenv` plugin

### AsyncStorage token not persisting
Check that storage.ts helpers are used correctly and AsyncStorage is imported from `@react-native-async-storage/async-storage`

### API returns 401 Unauthorized on protected routes
1. Verify token is stored: Check AsyncStorage in console
2. Check backend JWT configuration (BACKEND_FIX.md)
3. Look for `🔑 Token:` logs in Metro bundler
4. Token must be valid and not expired

### Physical device can't reach backend
1. Backend must bind to `0.0.0.0` not `127.0.0.1`
2. Run `./detect-ip.sh` to auto-configure correct IP
3. Check firewall settings on backend machine
4. Verify both devices on same network (or use ngrok)
